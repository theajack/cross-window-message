!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.initMessager=n():e.initMessager=n()}(this,(function(){return function(e){var n={};function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var i in e)t.d(r,i,function(n){return e[n]}.bind(null,i));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){"use strict";function r(){var e=[],n=null,t=!0;function r(n){var t=e.find((function(e){return e.listener===n}));t&&e.splice(e.indexOf(t),1)}return{onEventReady:function(t){for(var i=[],a=1;a<arguments.length;a++)i[a-1]=arguments[a];var o,u=!1,s=!1,c=!1;return"object"==typeof t?("boolean"==typeof t.once&&(u=t.once),"boolean"==typeof t.after&&(s=t.after),"boolean"==typeof t.head&&(c=t.head),o=t.listener):o=t,e.find((function(e){return e.listener===o}))||e[c?"unshift":"push"]({listener:o,args:i,once:u}),null===n||s||(0===i.length&&n&&(i=n),o.apply(void 0,i),u&&r(o)),o},eventReady:function(){for(var i=[],a=0;a<arguments.length;a++)i[a]=arguments[a];n=i,e.forEach((function(e){e.listener.apply(e,0===i.length?e.args:i),e.once&&r(e.listener)})),t=!1},removeListener:r,isFirstReady:function(){return t}}}t.r(n),t.d(n,"default",(function(){return W}));var i=window.localStorage;function a(e){return e+"_note"}function o(e,n){var t=typeof n;"object"===t?n=JSON.stringify(n):"string"!==t&&(n=n.toString()),i.setItem(a(e),t+":"+n)}function u(e){var n=i.getItem(a(e));return null===n?null:s(n)}function s(e){if(null===e)return null;var n=e.indexOf(":"),t="string";if(-1!==n){var r=e.substr(0,n);-1!==["string","number","boolean","object","undefined"].indexOf(r)&&(t=r,e=e.substr(n+1))}if("number"===t)return parseFloat(e);if("boolean"===t)return"true"===e;if("object"===t)try{return JSON.parse(e)}catch(e){return null}return e}function c(){var e={};return Object.keys(i).forEach((function(n){e[n]=i.getItem(n)})),e}function f(e){i.removeItem(a(e))}function d(){Object.keys(i).forEach((function(e){i.removeItem(e)}))}var l=function(e,n){if("object"!=typeof e||null===e)if(void 0===n){if(void 0===e)return c();if(null!==e)return u(e);d()}else{if(null!==n)return o(e,n);f(e)}else for(var t in e)l(t,e[t])};l.useLocalStorage=function(){i=window.localStorage},l.useSessionStorage=function(){i=window.sessionStorage},l.read=u,l.readAll=c,l.write=o,l.remove=f,l.clear=d,l.parseValue=s,l.parseKey=function(e){var n=e.length-"_note".length;return"_note"===e.substr(n)?e.substr(0,n):e},l.geneKey=a;var g=l,p=1,v=2,y=3,m=4,h=5,b=6,w=7,P=8;function S(){window.close(),setTimeout((function(){window.location.href="https://tackchen.gitee.io/404.html?h="+encodeURIComponent(location.host)}),100)}function T(e){void 0!==window.onunload?window.addEventListener("unload",e,!0):function(e){window.addEventListener("beforeunload",e,!0)}(e)}var x,k,M,O=(x="",k="visibilityState",M="",void 0!==document.hidden?(x="hidden",M="visibilitychange",k="visibilityState"):void 0!==document.mozHidden?(x="mozHidden",M="mozvisibilitychange",k="mozVisibilityState"):void 0!==document.msHidden?(x="msHidden",M="msvisibilitychange",k="msVisibilityState"):void 0!==document.webkitHidden&&(x="webkitHidden",M="webkitvisibilitychange",k="webkitVisibilityState"),{hidden:x,state:k,visibilityChange:M});function I(){return document[O.state]===O.hidden}var _;function j(){var e=g.read("cwm_page_queue");return e instanceof Array?e:[]}function E(e){var n=j(),t=n.find((function(n){return n.id===e}));return{pageQueue:n,page:t}}function N(e){_&&_(e,j()),g.write("cwm_page_queue",e)}function H(e){var n=0;return e.forEach((function(e){e.index>n&&(n=e.index)})),n}function L(e){!function(e,n){void 0===n&&(n=!0);var t=E(e),r=t.pageQueue,i=t.page;if(i)return r.splice(r.indexOf(i),1),n&&N(r),!0}(e.id)}function V(){var e=j();return 0===e.length?null:e[e.length-1]}function C(){var e=j();return 0===e.length?null:(e.sort((function(e,n){return n.index-e.index})),e[0])}function U(e,n){void 0===n&&(n=!1);var t=E(e),r=t.pageQueue,i=t.page;i&&(n&&(i.show=!0),r.splice(r.indexOf(i),1),r.push(i),N(r))}var R,B=[];function Q(e){R({innerMessageType:w}),setTimeout((function(){!function(e){for(var n=j(),t=!1,r=n.length-1;r>=0;r--)-1===e.indexOf(n[r].id)&&(n.splice(r,1),t=!0);t&&N(n)}(B)}),200),function e(n){setTimeout((function(){var t=E(n.id),r=t.pageQueue;t.page||(n.index=H(r)+1,r.push(n),N(r),A()&&e(n))}),100)}(e)}var z,A=(z=0,function(){return++z<=5});var q,K,D=function(){return(D=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var i in n=arguments[t])Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);return e}).apply(this,arguments)};function F(e,n){var t,r=e.innerMessageType,i=e.page,a=e.data,o=function(e){return n.id===e},u=function(e){return n.name===e};switch(r){case v:o(i.id)||S();break;case p:!o(i.id)&&u(i.name)&&S();break;case b:o(a.pageId)&&alert(a.text);break;case h:u(a.pageName)&&alert(a.text);break;case y:o(a)&&S();break;case m:u(a)&&S();break;case w:o(a)||K({targetPageId:i.id,innerMessageType:P});break;case P:t=i.id,-1===B.indexOf(t)&&B.push(t)}}function J(e,n){var t=0;R=K=function(r){var i=r.data,a=void 0===i?null:i,o=r.messageType,u=void 0===o?"":o,s=r.innerMessageType,c=r.targetPageId,f=r.targetPageName,d={data:a,page:e,messageType:u,messageId:e.id+"-"+t++};"number"==typeof s&&(d.innerMessageType=s),"string"==typeof c&&(d.targetPageId=c),"string"==typeof f&&(d.targetPageName=f),g.write("cross_window_msg",d),n(d)}}function G(e){return{closeOtherPage:function(){K({innerMessageType:v})},closeOtherSamePage:function(){K({innerMessageType:p})},alertInTargetName:function(e,n){K({data:{text:e,pageName:n},innerMessageType:h})},alertInTargetId:function(e,n){K({data:{text:e,pageId:n},innerMessageType:b})},closePageByPageName:function(e){K({data:e,innerMessageType:m})},closePageByPageId:function(e){K({data:e,innerMessageType:y})},getLastOpenPage:C,getLatestActivePage:V,getAllPages:function(){return j()},updatePageData:function(n,t){return void 0===t&&(t=!1),function(e,n,t){var r=E(n),i=r.pageQueue,a=r.page;if(!a)return console.warn("不存在的页面 pageId"),!1;if(t||!a.data)a.data=e;else for(var o in e)a.data[o]=e[o];return N(i),!0}(n,e,t)}}}function W(e){var n=void 0===e?{}:e,t=n.pageName,i=void 0===t?location.pathname.replace(/\//g,"_"):t,a=n.pageId,o=void 0===a?"":a,u=n.useSessionStorage,s=n.data;if(q)return q;!0===u&&g.useSessionStorage();var c=function(){var e;!function(e){e[e.Unload=0]="Unload",e[e.Click=1]="Click",e[e.Show=2]="Show",e[e.Hide=3]="Hide",e[e.BeforeUnload=4]="BeforeUnload"}(e||(e={}));var n=r(),t=n.onEventReady,i=n.eventReady,a=n.removeListener,o=function(e,n){var r=function(t){var r=t.type,i=t.event;n===r&&e(i)};return t({after:!0,listener:r}),function(){return a(r)}},u=function(e,n){return i({type:n,event:e})};return{events:{onBeforeUnload:function(n){return o(n,e.BeforeUnload)},onUnload:function(n){return o(n,e.Unload)},onClick:function(n){return o(n,e.Click)},onShow:function(n){return o(n,e.Show)},onHide:function(n){return o(n,e.Hide)}},triggerUnload:function(n){return u(n,e.Unload)},triggerClick:function(n){return u(n,e.Click)},triggerPageShow:function(n){return u(n,e.Show)},triggerPageHide:function(n){return u(n,e.Hide)}}}(),f=function(e,n,t){var r,i,a=j(),o={name:e,id:n||""+e+Date.now().toString().substr(4)+(r=1e5,i=999999,r+Math.round(Math.random()*(i-r))),index:H(a)+1,show:!I()};return void 0!==t&&(o.data=t),a.push(o),N(a),o}(i,o,s);T((function(e){L(f),c.triggerUnload(e)}));var d,l=r(),p=l.onEventReady,v=l.eventReady,y=l.removeListener,m=r();d=m.eventReady,_=d;var h=function(e,n){return function(t){var r="string"==typeof t.targetPageId,i="string"==typeof t.targetPageName;(!r&&!i||r&&t.targetPageId===e.id||i&&t.targetPageName===e.name)&&(t.innerMessageType?F(t,e):n(t))}}(f,v);!function(e,n){window.addEventListener("storage",(function(t){if(t.key){var r=g.parseKey(t.key);if("cross_window_msg"===r){var i=null!==t.newValue?g.parseValue(t.newValue):null;if(!i)return;e(i)}else"cwm_page_queue"===r&&n(null!==t.newValue?g.parseValue(t.newValue):[],null!==t.oldValue?g.parseValue(t.oldValue):[])}}),!1)}(h,m.eventReady),J(f,h);var b=D(D({pageId:f.id,pageName:i,postMessage:function(e,n){void 0===n&&(n=""),K({data:e,messageType:n})},postMessageToTargetId:function(e,n,t){K({targetPageId:e,data:n,messageType:t})},postMessageToTargetName:function(e,n,t){K({targetPageName:e,data:n,messageType:t})},onMessage:function(e){return p({listener:e,after:!0}),function(){return y(e)}},onPageChange:function(e){return m.onEventReady({listener:e,after:!0}),function(){return m.removeListener(e)}}},c.events),{method:G(f.id)});return q=b,Q(f),function(e,n){t=function(t){U(e,!0),n.triggerPageShow(t)},r=function(t){!function(e){var n=E(e),t=n.pageQueue,r=n.page;r&&(r.show=!1,N(t))}(e),n.triggerPageHide(t)},i=function(e){I()?r&&r(e):t(e)},document.removeEventListener(O.visibilityChange,i,!0),document.addEventListener(O.visibilityChange,i,!0),window.addEventListener("click",(function(t){U(e),n.triggerClick(t)}),!0);var t,r,i}(f.id,c),b}W.version="1.0.6"}]).default}));